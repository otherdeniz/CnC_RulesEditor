# C&C Rules Editor - Architecture Diagrams

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                         C&C Rules Editor                            │
│                         (WinForms .NET 6.0)                         │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
        ┌──────────────────┐ ┌──────────┐ ┌──────────────┐
        │   Main GUI       │ │  Audio   │ │   Updater    │
        │   Application    │ │  Player  │ │   Utility    │
        └──────────────────┘ └──────────┘ └──────────────┘
                    │
        ┌───────────┼───────────┐
        │           │           │
        ▼           ▼           ▼
    ┌────────┐ ┌────────┐ ┌────────┐
    │ Rules  │ │  Art   │ │   AI   │
    │ Editor │ │ Editor │ │ Editor │
    └────────┘ └────────┘ └────────┘
        │           │           │
        └───────────┼───────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌──────────────┐        ┌──────────────┐
│ Game Assets  │        │ Configuration│
│  (MIX Files) │        │  (JSON Files)│
└──────────────┘        └──────────────┘
```

## Component Interaction Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                            MainForm                                 │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                      Tab Control                              │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐         │ │
│  │  │ Rules Tab    │ │  Art Tab     │ │  AI Tab      │         │ │
│  │  └──────────────┘ └──────────────┘ └──────────────┘         │ │
│  └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
    ┌──────────────────┐ ┌──────────────┐ ┌──────────────┐
    │RulesEditMain     │ │ArtEditMain   │ │AiEditMain    │
    │Control           │ │Control       │ │Control       │
    └──────────────────┘ └──────────────┘ └──────────────┘
                │               │               │
        ┌───────┴───────┐       │       ┌───────┴───────┐
        │               │       │       │               │
        ▼               ▼       ▼       ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│EntitiesList  │ │UnitEdit      │ │SmallEntity   │ │FilterControl │
│Control       │ │Control       │ │Control       │ │              │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
        │               │
        └───────┬───────┘
                │
                ▼
        ┌──────────────┐
        │GameEntity    │
        │Model         │
        └──────────────┘
```

## Data Flow Diagram

```
┌─────────────┐
│   User      │
│   Action    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                      MainForm                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  File Menu → Open File                               │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    IniFile.Load()                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  • Read file from disk                               │   │
│  │  • Parse sections and key-value pairs                │   │
│  │  • Preserve comments                                 │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              GameTypeDetector.DetectGame()                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  • Check [General]->Name                             │   │
│  │  • Match against IniNameMatchDetection               │   │
│  │  • Return GameDefinition                             │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│            RulesRootModel.Load()                            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  • Load Datastructure.json                           │   │
│  │  • Parse entity sections                             │   │
│  │  • Create GameEntityModel for each entity            │   │
│  │  • Load values from INI                              │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│         RulesEditMainControl.LoadModel()                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  • Bind model to UI                                  │   │
│  │  • Populate entity lists                             │   │
│  │  • Setup event handlers                              │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    Display in UI                            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  • Show entity list                                  │   │
│  │  • Enable editing                                    │   │
│  │  • Load game assets                                  │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## Game Asset Loading Flow

```
┌─────────────────────────────────────────────────────────────┐
│              User Selects Game Path                         │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│        CCGameRepository.Initialise()                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌──────────────┐ ┌──────────┐ ┌──────────────┐
│ Load MIX     │ │  Load    │ │  Load        │
│ Files        │ │ Palettes │ │  INI Files   │
└──────┬───────┘ └────┬─────┘ └──────┬───────┘
       │              │              │
       ▼              ▼              ▼
┌──────────────┐ ┌──────────┐ ┌──────────────┐
│cache.mix     │ │cameo.pal │ │art.ini       │
│conquer.mix   │ │anim.pal  │ │sound.ini     │
│local.mix     │ │unittem.pal│ │              │
└──────┬───────┘ └────┬─────┘ └──────┬───────┘
       │              │              │
       └──────────────┼──────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │   Assets Ready for Use      │
        └─────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌──────────────┐ ┌─────────┐ ┌──────────┐
│Get Cameo     │ │Get Anim │ │Play Sound│
│  (SHP)       │ │ (SHP)   │ │  (AUD)   │
└──────────────┘ └─────────┘ └──────────┘
```

## Class Hierarchy

```
┌─────────────────────────────────────────────────────────────┐
│                         Models                              │
└─────────────────────────────────────────────────────────────┘

                    ┌──────────────────┐
                    │  RulesRootModel  │
                    └────────┬─────────┘
                             │
                ┌────────────┼────────────┐
                │            │            │
                ▼            ▼            ▼
        ┌──────────┐  ┌──────────┐  ┌──────────┐
        │Buildings │  │Infantry  │  │Vehicles  │
        │  List    │  │  List    │  │  List    │
        └────┬─────┘  └────┬─────┘  └────┬─────┘
             │             │             │
             └─────────────┼─────────────┘
                           │
                           ▼
                ┌──────────────────────┐
                │  GameEntityModel     │
                └──────────┬───────────┘
                           │
                ┌──────────┼──────────┐
                │          │          │
                ▼          ▼          ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │  Key     │ │  Name    │ │  Image   │
        └──────────┘ └──────────┘ └──────────┘
                           │
                           ▼
                ┌──────────────────────┐
                │ EntityValueModel[]   │
                └──────────────────────┘
                           │
                ┌──────────┼──────────┐
                │          │          │
                ▼          ▼          ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ Lookup   │ │  Text    │ │  Multi   │
        │ Value    │ │  Value   │ │  Value   │
        └──────────┘ └──────────┘ └──────────┘
```

## Repository Pattern

```
┌─────────────────────────────────────────────────────────────┐
│                      Repositories                           │
│                      (Singletons)                           │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────┐     ┌──────────────────────┐
│  CCGameRepository    │     │ ResourcesRepository  │
│  (Game Assets)       │     │ (Configuration)      │
└──────────┬───────────┘     └──────────┬───────────┘
           │                            │
    ┌──────┼──────┐              ┌──────┼──────┐
    │      │      │              │      │      │
    ▼      ▼      ▼              ▼      ▼      ▼
┌──────┐┌──────┐┌──────┐    ┌──────┐┌──────┐┌──────┐
│Cameos││Anims ││Sounds│    │Games ││Data  ││Value │
│Cache ││Cache ││      │    │.json ││struct││Types │
└──────┘└──────┘└──────┘    └──────┘└──────┘└──────┘
    │      │      │              │      │      │
    └──────┼──────┘              └──────┼──────┘
           │                            │
           ▼                            ▼
    ┌──────────────┐            ┌──────────────┐
    │CCFileManager │            │GameDefinition│
    └──────────────┘            └──────────────┘
           │                            │
           ▼                            ▼
    ┌──────────────┐            ┌──────────────┐
    │  MixFile[]   │            │Datastructure │
    └──────────────┘            │Definition    │
                                └──────────────┘
```

## File Parser Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    File Parsers                             │
│                 (Utils/CncParser/)                          │
└─────────────────────────────────────────────────────────────┘

┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   MixFile    │  │   ShpFile    │  │   AudFile    │
│   Parser     │  │   Parser     │  │   Parser     │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│Read Header   │  │Read Header   │  │Read Header   │
│Check Encrypt │  │Get Frame     │  │Check Compress│
│Build Index   │  │Count         │  │Type          │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│Decrypt if    │  │Parse Frame   │  │Decompress    │
│Needed        │  │Data          │  │IMA ADPCM     │
│(Blowfish)    │  │              │  │              │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│Extract File  │  │Apply Palette │  │Convert to    │
│by CRC        │  │Render Bitmap │  │PCM Stream    │
└──────────────┘  └──────────────┘  └──────────────┘

┌──────────────┐  ┌──────────────┐
│   PalFile    │  │   CsfFile    │
│   Parser     │  │   Parser     │
└──────┬───────┘  └──────┬───────┘
       │                 │
       ▼                 ▼
┌──────────────┐  ┌──────────────┐
│Read 256      │  │Read Header   │
│RGB Colors    │  │Parse Labels  │
└──────┬───────┘  └──────┬───────┘
       │                 │
       ▼                 ▼
┌──────────────┐  ┌──────────────┐
│Convert 6-bit │  │Read Unicode  │
│to 8-bit RGB  │  │Strings       │
└──────────────┘  └──────────────┘
```

## UI Control Hierarchy

```
┌─────────────────────────────────────────────────────────────┐
│                        MainForm                             │
│                     (Main Window)                           │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ToolbarsManager│    │ TabControl   │    │ StatusBar    │
└──────────────┘    └──────┬───────┘    └──────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ Rules Tab    │    │  Art Tab     │    │  AI Tab      │
└──────┬───────┘    └──────┬───────┘    └──────┬───────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌──────────────────────────────────────────────────────┐
│            EditMainControl (Base)                    │
└──────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│EntitiesList  │    │ UnitEdit     │    │ Filter       │
│Control       │    │ Control      │    │ Control      │
└──────┬───────┘    └──────┬───────┘    └──────────────┘
       │                   │
       │                   ▼
       │            ┌──────────────┐
       │            │ Value        │
       │            │ Controls     │
       │            └──────┬───────┘
       │                   │
       │        ┌──────────┼──────────┐
       │        │          │          │
       │        ▼          ▼          ▼
       │  ┌──────────┐┌──────────┐┌──────────┐
       │  │ Lookup   ││  Text    ││  Color   ││
       │  │ Control  ││  Control ││  Control ││
       │  └──────────┘└──────────┘└──────────┘
       │
       ▼
┌──────────────┐
│ UltraGrid    │
│ (Infragistics)│
└──────────────┘
```

## Configuration Loading Flow

```
┌─────────────────────────────────────────────────────────────┐
│              Application Startup                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│         ResourcesRepository.Initialize()                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌──────────────┐ ┌──────────┐ ┌──────────────┐
│Load Games    │ │  Load    │ │  Load        │
│.json         │ │Datastruc │ │  Themes      │
│              │ │ture.json │ │  .json       │
└──────┬───────┘ └────┬─────┘ └──────┬───────┘
       │              │              │
       ▼              ▼              ▼
┌──────────────┐ ┌──────────┐ ┌──────────────┐
│Parse Game    │ │Parse     │ │Parse Theme   │
│Definitions   │ │Value     │ │Definitions   │
│              │ │Defs      │ │              │
└──────┬───────┘ └────┬─────┘ └──────┬───────┘
       │              │              │
       └──────────────┼──────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │   Configuration Ready       │
        └─────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌──────────────┐ ┌─────────┐ ┌──────────┐
│Populate      │ │Apply    │ │Load User │
│Game Menu     │ │Theme    │ │Settings  │
└──────────────┘ └─────────┘ └──────────┘
```

## Save Operation Flow

```
┌─────────────────────────────────────────────────────────────┐
│              User Clicks Save                               │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│            MainForm.ButtonSave()                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│         RulesRootModel.SaveToIni()                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌──────────────┐ ┌──────────┐ ┌──────────────┐
│Update Entity │ │Update    │ │Update Common │
│Sections      │ │Lists     │ │Values        │
└──────┬───────┘ └────┬─────┘ └──────┬───────┘
       │              │              │
       └──────────────┼──────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│            IniFile.SaveAs(path)                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌──────────────┐ ┌──────────┐ ┌──────────────┐
│Write         │ │Preserve  │ │Write to      │
│Sections      │ │Comments  │ │Disk          │
└──────────────┘ └──────────┘ └──────────────┘
```

---

**Document Version:** 1.0  
**Last Updated:** 2024  
**For Application Version:** 2.6.60
